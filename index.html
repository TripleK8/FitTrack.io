<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KENG2026 Sport Science System v2.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK v11 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global App Context
        window.App = {
            db: null,
            auth: null,
            user: null,
            patients: [],
            activeTab: 'dashboard',
            appId: typeof __app_id !== 'undefined' ? __app_id : 'keng2026-sport-sci',

            async init() {
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : {
                        apiKey: "", // Key provided by environment
                        authDomain: "fitness-1414f.firebaseapp.com",
                        projectId: "fitness-1414f",
                        storageBucket: "fitness-1414f.firebasestorage.app",
                        messagingSenderId: "778205778078",
                        appId: "1:778205778078:web:c4af1300f1611ad9576b8f"
                    };

                const app = initializeApp(firebaseConfig);
                this.auth = getAuth(app);
                this.db = getFirestore(app);

                // Auth Logic (Rule 3)
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(this.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(this.auth);
                        }
                    } catch (e) {
                        console.error("Auth error:", e);
                    }
                };
                
                await initAuth();

                onAuthStateChanged(this.auth, (user) => {
                    this.user = user;
                    if (user) {
                        this.setupListeners();
                    }
                });

                lucide.createIcons();
                if (localStorage.getItem('keng_session') === 'active') {
                    this.showMain(false);
                }
            },

            setupListeners() {
                if (!this.user) return;
                // Rule 1 & 2: Specific path and client-side sorting
                const q = query(collection(this.db, 'artifacts', this.appId, 'public', 'data', 'patients'));
                
                onSnapshot(q, (snapshot) => {
                    this.patients = [];
                    snapshot.forEach((doc) => this.patients.push({ ...doc.data(), id: doc.id }));
                    
                    // Client-side sort by updatedAt
                    this.patients.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                    this.refreshUI();
                }, (err) => {
                    console.error("Firestore error:", err);
                });
            },

            refreshUI() {
                this.updateDash();
                this.renderTable();
                this.populateSyncDropdown();
                lucide.createIcons();
            },

            // Navigation
            setTab(t) {
                this.activeTab = t;
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                const target = document.getElementById(`view-${t}`);
                if (target) target.classList.remove('hidden');
                
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('sidebar-item-active'));
                const navBtn = document.getElementById(`nav-${t}`);
                if (navBtn) navBtn.classList.add('sidebar-item-active');
                
                const titles = { 'dashboard': 'Overview', 'patients': 'Registry', 'fitness': 'Lab Tools', 'form': 'Athlete Entry' };
                document.getElementById('page-title').innerText = titles[t] || 'Dashboard';
                lucide.createIcons();
            },

            // Dashboard
            updateDash() {
                document.getElementById('stat-total').innerText = this.patients.length;
                const bmis = this.patients.map(p => parseFloat(p.bmi)).filter(v => !isNaN(v));
                document.getElementById('stat-avg-bmi').innerText = bmis.length 
                    ? (bmis.reduce((a, b) => a + b, 0) / bmis.length).toFixed(1) 
                    : "0";
                
                const list = document.getElementById('recent-list');
                list.innerHTML = this.patients.slice(0, 4).map(p => `
                    <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl shadow-sm hover:shadow-md transition-all cursor-pointer" onclick="App.viewPatient('${p.id}')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center font-bold">${p.name.charAt(0)}</div>
                            <div>
                                <p class="font-bold text-slate-800 text-sm">${p.name}</p>
                                <p class="text-[10px] text-slate-400 uppercase font-black tracking-tighter">${p.nickname || '-'}</p>
                            </div>
                        </div>
                        <span class="metric-badge">BMI ${p.bmi || '-'}</span>
                    </div>
                `).join('') || '<p class="text-center text-slate-400 py-6 text-xs font-bold italic col-span-2 w-full">Waiting for athlete data...</p>';
            },

            // Registry Management
            renderTable() {
                const search = document.getElementById('search-input').value.toLowerCase();
                const tbody = document.getElementById('patient-table-body');
                const filtered = this.patients.filter(p => 
                    p.name.toLowerCase().includes(search) || 
                    (p.nickname && p.nickname.toLowerCase().includes(search))
                );
                
                tbody.innerHTML = filtered.map(p => `
                    <tr class="hover:bg-slate-50/50 transition-colors group">
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-800">${p.name}</div>
                            <div class="text-[10px] text-slate-400 font-black uppercase">${p.nickname || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <span class="px-2 py-1 bg-slate-100 rounded text-[10px] font-bold text-slate-600">${p.age}Y</span>
                                <span class="px-2 py-1 bg-sky-50 rounded text-[10px] font-bold text-sky-600">BMI ${p.bmi}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="App.viewPatient('${p.id}')" class="p-2 text-slate-400 hover:text-sky-500 hover:bg-sky-50 rounded-lg transition-all"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                <button onclick="App.editPatient('${p.id}')" class="p-2 text-slate-400 hover:text-amber-500 hover:bg-amber-50 rounded-lg transition-all"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="App.deletePatient('${p.id}')" class="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                lucide.createIcons();
            },

            async savePatient() {
                if (!this.user) return;
                const id = document.getElementById('p-edit-id').value || crypto.randomUUID();
                const w = parseFloat(document.getElementById('p-weight').value) || 0;
                const h = parseFloat(document.getElementById('p-height').value) || 0;
                
                const data = {
                    name: document.getElementById('p-name').value,
                    nickname: document.getElementById('p-nickname').value,
                    weight: w,
                    height: h,
                    age: parseInt(document.getElementById('p-age').value) || 0,
                    rhr: parseInt(document.getElementById('p-rhr').value) || 0,
                    note: document.getElementById('p-note').value,
                    bmi: h > 0 ? (w / ((h / 100) ** 2)).toFixed(1) : 0,
                    updatedAt: Date.now()
                };

                try {
                    await setDoc(doc(this.db, 'artifacts', this.appId, 'public', 'data', 'patients', id), data, { merge: true });
                    this.toast("Cloud Sync Successful", "cloud-check");
                    this.resetForm();
                    this.setTab('patients');
                } catch (e) {
                    this.toast("Sync Failed", "alert-circle");
                }
            },

            editPatient(id) {
                const p = this.patients.find(i => i.id === id);
                if (!p) return;
                document.getElementById('p-edit-id').value = p.id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-nickname').value = p.nickname || '';
                document.getElementById('p-weight').value = p.weight;
                document.getElementById('p-height').value = p.height;
                document.getElementById('p-age').value = p.age;
                document.getElementById('p-rhr').value = p.rhr;
                document.getElementById('p-note').value = p.note || '';
                this.setTab('form');
            },

            async deletePatient(id) {
                if (!confirm("Delete this athlete from cloud registry?")) return;
                try {
                    await deleteDoc(doc(this.db, 'artifacts', this.appId, 'public', 'data', 'patients', id));
                    this.toast("Record Deleted", "trash-2");
                } catch (e) {
                    this.toast("Error deleting", "x-circle");
                }
            },

            viewPatient(id) {
                const p = this.patients.find(i => i.id === id);
                if (!p) return;
                
                const modal = document.getElementById('profile-modal');
                const content = document.getElementById('profile-content');
                
                content.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-sky-500 text-white rounded-2xl flex items-center justify-center text-2xl font-black shadow-lg shadow-sky-100">${p.name.charAt(0)}</div>
                            <div>
                                <h2 class="text-2xl font-black text-slate-800 tracking-tighter">${p.name}</h2>
                                <p class="text-sm font-bold text-sky-500 uppercase tracking-widest">${p.nickname || 'Baseline Entry'}</p>
                            </div>
                        </div>
                        <button onclick="App.closeModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x"></i></button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[9px] font-black text-slate-400 uppercase">Age</p>
                            <p class="text-lg font-bold text-slate-700">${p.age}Y</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[9px] font-black text-slate-400 uppercase">BMI</p>
                            <p class="text-lg font-bold text-slate-700">${p.bmi}</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[9px] font-black text-slate-400 uppercase">Weight</p>
                            <p class="text-lg font-bold text-slate-700">${p.weight}kg</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[9px] font-black text-slate-400 uppercase">RHR</p>
                            <p class="text-lg font-bold text-slate-700">${p.rhr} bpm</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="p-4 bg-slate-900 rounded-3xl text-white">
                            <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Internal Coaching Notes</h4>
                            <p class="text-xs italic leading-relaxed text-slate-300">${p.note || 'No specific coaching observations recorded yet.'}</p>
                        </div>
                    </div>

                    <div class="mt-8 flex gap-3">
                        <button onclick="App.editPatient('${p.id}'); App.closeModal();" class="flex-1 theme-btn py-4 text-xs font-black uppercase tracking-widest">Edit Athlete Profile</button>
                    </div>
                `;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                lucide.createIcons();
            },

            // Lab Tools
            calculateMetabolic() {
                const w = parseFloat(document.getElementById('fit-weight').value)||0, 
                      h = parseFloat(document.getElementById('fit-height').value)||0, 
                      a = parseInt(document.getElementById('fit-age').value)||0, 
                      g = document.getElementById('fit-gender').value, 
                      act = parseFloat(document.getElementById('fit-activity').value);
                
                if(w<=0||h<=0||a<=0) return;
                const bmr = (10*w) + (6.25*h) - (5*a) + (g === 'male' ? 5 : -161);
                const tdee = bmr * act;
                
                document.getElementById('res-bmr').innerText = Math.round(bmr);
                document.getElementById('res-tdee').innerText = Math.round(tdee);

                const id = document.getElementById('fit-registry-select').value;
                if(id) this.updatePatientData(id, { weight: w, height: h, age: a, bmr: Math.round(bmr), tdee: Math.round(tdee) });
                this.toast("Metabolic Analysis Saved", "zap");
            },

            calculateHR() {
                const a = parseInt(document.getElementById('fit-hr-age').value)||0, 
                      r = parseInt(document.getElementById('fit-hr-rhr').value)||0;
                if(a <= 0 || r <= 0) return;
                const mhr = 208 - (0.7 * a); 
                const hrr = mhr - r;
                const box = document.getElementById('res-hr-zones'); box.innerHTML = ''; box.classList.remove('hidden');

                const zones = [
                    {n:"Zone 2 (Endurance)", p:[0.6,0.7], c:"bg-sky-50 text-sky-700"},
                    {n:"Zone 4 (Threshold)", p:[0.8,0.9], c:"bg-orange-50 text-orange-700"},
                    {n:"Zone 5 (VO2 Max)", p:[0.9,1.0], c:"bg-rose-50 text-rose-700"}
                ];

                zones.forEach(z => {
                    const low = Math.round((hrr * z.p[0]) + r), high = Math.round((hrr * z.p[1]) + r);
                    box.innerHTML += `<div class="p-3 rounded-xl ${z.c} border flex justify-between font-bold text-[10px]"><span>${z.n}</span><span>${low}-${high} bpm</span></div>`;
                });

                const id = document.getElementById('fit-registry-select').value;
                if(id) this.updatePatientData(id, { age: a, rhr: r, maxHR: Math.round(mhr) });
                this.toast("Cardio Profile Synchronized", "heart");
            },

            async updatePatientData(id, newData) {
                if (!this.user) return;
                try {
                    await updateDoc(doc(this.db, 'artifacts', this.appId, 'public', 'data', 'patients', id), { ...newData, updatedAt: Date.now() });
                } catch (e) { console.error("Update failed", e); }
            },

            populateSyncDropdown() {
                const sel = document.getElementById('fit-registry-select');
                if(!sel) return;
                const val = sel.value;
                sel.innerHTML = '<option value="">Select Athlete Profile...</option>' + 
                    this.patients.map(p => `<option value="${p.id}" ${p.id === val ? 'selected' : ''}>${p.name}</option>`).join('');
            },

            loadFromRegistry() {
                const id = document.getElementById('fit-registry-select').value;
                const p = this.patients.find(i => i.id === id);
                if(p) {
                    const fields = {
                        'fit-weight': p.weight, 'fit-height': p.height, 'fit-age': p.age,
                        'fit-hr-age': p.age, 'fit-hr-rhr': p.rhr
                    };
                    Object.keys(fields).forEach(key => {
                        const el = document.getElementById(key);
                        if(el) el.value = fields[key] || '';
                    });
                    this.toast(`Synchronized: ${p.name}`, "refresh-cw");
                }
            },

            // System Ops
            handleLogin() {
                if (document.getElementById('login-pass').value === 'korntawat') {
                    localStorage.setItem('keng_session', 'active');
                    this.showMain(true);
                } else {
                    this.toast("Access Denied", "shield-off");
                }
            },

            showMain(isInitial) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-system').classList.remove('hidden');
                this.setTab('dashboard');
                if(isInitial) this.init(); 
            },

            logout() {
                localStorage.removeItem('keng_session');
                location.reload();
            },

            closeModal() {
                const modal = document.getElementById('profile-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            },

            toast(m, i) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = m;
                document.getElementById('toast-icon').innerHTML = `<i data-lucide="${i}" class="w-5 h-5 text-sky-500"></i>`;
                lucide.createIcons();
                t.classList.remove('translate-y-32', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
            },

            resetForm() {
                document.getElementById('patient-form').reset();
                document.getElementById('p-edit-id').value = '';
            },

            toggleSidebar() {
                document.getElementById('sidebar').classList.toggle('-translate-x-full');
            }
        };

        window.onload = () => App.init();
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .theme-btn { 
            background: #0ea5e9; color: white; border-radius: 14px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: none; cursor: pointer;
        }
        .theme-btn:hover { background: #0284c7; transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.3); }
        .theme-btn:active { transform: translateY(0); }
        
        .classic-card { background: white; border-radius: 28px; border: 1px solid #f1f5f9; transition: all 0.3s ease; }
        .classic-card:hover { border-color: #e2e8f0; }
        
        .sidebar-item-active { background-color: #f0f9ff; color: #0ea5e9; font-weight: 700; border-right: 4px solid #0ea5e9; }
        
        .clean-input {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 14px;
            padding: 0.875rem 1.25rem; width: 100%; font-size: 0.925rem; transition: all 0.2s;
        }
        .clean-input:focus { background: white; border-color: #0ea5e9; outline: none; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
        
        .metric-badge { background: #f1f5f9; color: #475569; padding: 6px 12px; border-radius: 10px; font-size: 10px; font-weight: 800; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .fade-enter { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    </style>
</head>
<body class="text-slate-600 antialiased overflow-hidden">

    <!-- Login Layer -->
    <div id="login-view" class="fixed inset-0 z-[500] flex items-center justify-center p-4 bg-slate-900">
        <div class="bg-white p-12 max-w-sm w-full rounded-[48px] shadow-2xl text-center">
            <div class="w-24 h-24 bg-sky-500 text-white rounded-3xl flex items-center justify-center shadow-xl shadow-sky-100 mx-auto mb-10">
                <i data-lucide="shield-check" class="w-12 h-12"></i>
            </div>
            <h2 class="text-3xl font-black text-slate-800 tracking-tighter uppercase">KENG 2026</h2>
            <p class="text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] mt-2 mb-10">Sport Medicine Cloud</p>
            <div class="space-y-4">
                <input type="password" id="login-pass" class="clean-input text-center font-bold tracking-[0.5em]" placeholder="••••••••" onkeydown="if(event.key==='Enter') App.handleLogin()">
                <button onclick="App.handleLogin()" class="theme-btn w-full py-5 font-black uppercase text-xs tracking-widest">Verify Authority</button>
            </div>
        </div>
    </div>

    <!-- Main System Container -->
    <div id="main-system" class="flex h-screen hidden relative">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r flex flex-col transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300">
            <div class="p-10 flex items-center gap-4">
                <div class="w-10 h-10 bg-sky-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i data-lucide="zap" class="w-6 h-6"></i></div>
                <span class="font-black text-xl text-slate-800 uppercase tracking-tighter">KENG<span class="text-sky-500">2026</span></span>
            </div>
            <nav class="flex-1 px-4 space-y-2 overflow-y-auto hide-scroll">
                <button onclick="App.setTab('dashboard')" id="nav-dashboard" class="nav-item sidebar-item-active w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i><span class="text-sm font-bold uppercase tracking-tight">Overview</span>
                </button>
                <button onclick="App.setTab('patients')" id="nav-patients" class="nav-item w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="users" class="w-5 h-5"></i><span class="text-sm font-bold uppercase tracking-tight">Registry</span>
                </button>
                <button onclick="App.setTab('fitness')" id="nav-fitness" class="nav-item w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="flask-conical" class="w-5 h-5"></i><span class="text-sm font-bold uppercase tracking-tight">Lab Tools</span>
                </button>
                <button onclick="App.setTab('form')" id="nav-form" class="nav-item w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="user-plus" class="w-5 h-5"></i><span class="text-sm font-bold uppercase tracking-tight">New Entry</span>
                </button>
            </nav>
            <div class="p-8">
                <button onclick="App.logout()" class="w-full py-4 text-[10px] font-black text-rose-400 border border-rose-50 rounded-2xl hover:bg-rose-50 uppercase tracking-widest transition-all">Sign Out</button>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 flex flex-col bg-[#f8fafc] overflow-y-auto min-w-0">
            <header class="h-24 bg-white/80 backdrop-blur-md border-b flex items-center justify-between px-10 sticky top-0 z-40">
                <div class="flex items-center gap-5">
                    <button onclick="App.toggleSidebar()" class="lg:hidden p-3 bg-slate-50 rounded-xl"><i data-lucide="menu"></i></button>
                    <h1 id="page-title" class="font-black text-slate-800 text-xl uppercase tracking-[0.15em]">Overview</h1>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Status</p>
                        <p class="text-[11px] font-bold text-emerald-500">Cloud Link Active</p>
                    </div>
                    <div class="w-12 h-12 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center shadow-inner"><i data-lucide="globe" class="w-6 h-6"></i></div>
                </div>
            </header>

            <div class="p-10 max-w-6xl mx-auto w-full">
                <!-- Dashboard -->
                <section id="view-dashboard" class="fade-enter space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="classic-card p-10"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Total Athletes</p><h2 id="stat-total" class="text-6xl font-black text-slate-800 tracking-tighter">0</h2></div>
                        <div class="classic-card p-10"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Avg BMI Index</p><h2 id="stat-avg-bmi" class="text-6xl font-black text-emerald-500 tracking-tighter">0</h2></div>
                        <div class="classic-card p-10 bg-sky-500 text-white border-none shadow-xl shadow-sky-100"><p class="text-[10px] font-black text-sky-100 uppercase tracking-widest mb-2">Protocol</p><h2 class="text-4xl font-black tracking-tighter">V2.0 PRO</h2></div>
                    </div>
                    <div class="classic-card p-10">
                        <h3 class="font-black text-slate-800 text-xs uppercase tracking-[0.2em] mb-8 flex items-center gap-3"><i data-lucide="history" class="w-4 h-4 text-sky-500"></i> Recent Registrations</h3>
                        <div id="recent-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </section>

                <!-- Registry -->
                <section id="view-patients" class="hidden fade-enter space-y-8">
                    <div class="flex flex-col md:flex-row gap-6 items-center justify-between">
                        <div class="relative w-full md:w-96">
                            <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="search-input" onkeyup="App.renderTable()" class="clean-input pl-14" placeholder="Search athletes by name...">
                        </div>
                        <button onclick="App.setTab('form')" class="theme-btn px-10 py-4 text-xs font-black uppercase tracking-widest">+ Add Athlete</button>
                    </div>
                    <div class="classic-card overflow-hidden shadow-xl shadow-slate-200/50">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b"><tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest"><th class="px-8 py-5">Athlete Info</th><th class="px-8 py-5">Performance Profile</th><th class="px-8 py-5 text-right">Actions</th></tr></thead>
                            <tbody id="patient-table-body" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </section>

                <!-- Lab Tools -->
                <section id="view-fitness" class="hidden fade-enter space-y-8">
                    <div class="classic-card p-10 border-t-8 border-t-sky-500 bg-gradient-to-br from-white to-sky-50/20 flex flex-col md:flex-row items-center gap-8">
                        <div class="flex-1"><h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">Sync Baseline Metrics</h3><p class="text-xs text-slate-400 font-bold mt-1 uppercase">Load current athlete data from registry to analysis modules</p></div>
                        <div class="flex gap-3 w-full md:w-auto"><select id="fit-registry-select" class="clean-input md:w-80 bg-white"></select><button onclick="App.loadFromRegistry()" class="theme-btn px-8 py-4 text-xs font-black uppercase tracking-widest">Load</button></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Cardiac Module -->
                        <div class="classic-card p-10 border-t-8 border-t-emerald-500">
                            <div class="flex justify-between items-start mb-10">
                                <div><h3 class="font-black uppercase text-sm tracking-widest text-slate-800">Cardio Intensity Lab</h3><p class="text-[9px] font-black text-slate-400 uppercase mt-1">Karvonen / Polar Standard</p></div>
                                <div class="w-12 h-12 bg-emerald-50 text-emerald-500 rounded-2xl flex items-center justify-center"><i data-lucide="heart-pulse"></i></div>
                            </div>
                            <div class="grid grid-cols-2 gap-6 mb-6">
                                <div><label class="text-[9px] font-black text-slate-400 uppercase block mb-2">Age (Yrs)</label><input type="number" id="fit-hr-age" class="clean-input"></div>
                                <div><label class="text-[9px] font-black text-slate-400 uppercase block mb-2">Rest HR (bpm)</label><input type="number" id="fit-hr-rhr" class="clean-input"></div>
                            </div>
                            <button onclick="App.calculateHR()" class="theme-btn w-full py-4 bg-emerald-500 hover:bg-emerald-600 uppercase font-black text-xs tracking-widest shadow-lg shadow-emerald-100">Establish Zones</button>
                            <div id="res-hr-zones" class="mt-8 space-y-3 hidden"></div>
                        </div>
                        <!-- Metabolic Module -->
                        <div class="classic-card p-10 border-t-8 border-t-amber-500">
                            <div class="flex justify-between items-start mb-10">
                                <div><h3 class="font-black uppercase text-sm tracking-widest text-slate-800">Energy Expenditure</h3><p class="text-[9px] font-black text-slate-400 uppercase mt-1">Mifflin-St Jeor Equation</p></div>
                                <div class="w-12 h-12 bg-amber-50 text-amber-500 rounded-2xl flex items-center justify-center"><i data-lucide="flame"></i></div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <input type="number" id="fit-weight" class="clean-input" placeholder="kg">
                                <input type="number" id="fit-height" class="clean-input" placeholder="cm">
                                <input type="number" id="fit-age" class="clean-input" placeholder="age">
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <select id="fit-gender" class="clean-input"><option value="male">Male</option><option value="female">Female</option></select>
                                <select id="fit-activity" class="clean-input"><option value="1.2">Sedentary</option><option value="1.55">Moderate</option><option value="1.9">Elite</option></select>
                            </div>
                            <button onclick="App.calculateMetabolic()" class="theme-btn w-full py-4 bg-amber-500 hover:bg-amber-600 uppercase font-black text-xs tracking-widest shadow-lg shadow-amber-100">Calculate Meta-Data</button>
                            <div class="grid grid-cols-2 gap-6 mt-8">
                                <div class="p-6 bg-slate-50 rounded-3xl text-center border border-slate-100"><p class="text-[8px] font-black text-slate-400 uppercase mb-1">BMR (kcal)</p><p id="res-bmr" class="text-3xl font-black text-slate-800">0</p></div>
                                <div class="p-6 bg-slate-50 rounded-3xl text-center border border-slate-100"><p class="text-[8px] font-black text-slate-400 uppercase mb-1">TDEE (kcal)</p><p id="res-tdee" class="text-3xl font-black text-slate-800">0</p></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Entry Form -->
                <section id="view-form" class="hidden fade-enter">
                    <div class="classic-card p-12 lg:max-w-4xl mx-auto shadow-2xl shadow-slate-200">
                        <form id="patient-form" onsubmit="event.preventDefault(); App.savePatient();" class="space-y-8">
                            <input type="hidden" id="p-edit-id">
                            <div class="flex items-center gap-5 mb-10">
                                <div class="w-14 h-14 bg-sky-50 text-sky-500 rounded-3xl flex items-center justify-center shadow-inner"><i data-lucide="user-plus" class="w-7 h-7"></i></div>
                                <div><h3 class="text-2xl font-black text-slate-800 tracking-tight">Athlete Profiling</h3><p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Entry Baseline Measurements</p></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="md:col-span-2"><label class="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Full Name (Legal/Competition)</label><input type="text" id="p-name" required class="clean-input font-bold" placeholder="Somchai Thai"></div>
                                <div><label class="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Alias / Code Name</label><input type="text" id="p-nickname" class="clean-input"></div>
                                <div><label class="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Age (Years)</label><input type="number" id="p-age" class="clean-input"></div>
                                <div><label class="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Weight (kg)</label><input type="number" id="p-weight" step="0.1" class="clean-input"></div>
                                <div><label class="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Height (cm)</label><input type="number" id="p-height" class="clean-input"></div>
                                <div><label class="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Resting Heart Rate</label><input type="number" id="p-rhr" class="clean-input"></div>
                                <div class="md:col-span-2"><label class="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Specialist Observations</label><textarea id="p-note" rows="5" class="clean-input resize-none" placeholder="Injury history, biomechanical notes, or coaching focus..."></textarea></div>
                            </div>
                            <button type="submit" class="theme-btn w-full py-5 font-black uppercase text-xs tracking-[0.25em] mt-8 shadow-xl shadow-sky-100">Commit Record to Cloud</button>
                        </form>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal Layer -->
    <div id="profile-modal" class="fixed inset-0 z-[150] hidden items-center justify-center p-6 bg-slate-900/60 backdrop-blur-xl">
        <div id="profile-content" class="bg-white p-12 max-w-2xl w-full rounded-[64px] shadow-2xl relative overflow-y-auto max-h-[90vh]"></div>
    </div>

    <!-- Toast Layer -->
    <div id="toast" class="fixed bottom-10 right-10 bg-white border border-slate-100 px-8 py-5 rounded-3xl shadow-2xl translate-y-32 opacity-0 transition-all duration-500 flex items-center gap-5 z-[400]">
        <div id="toast-icon" class="w-10 h-10 bg-sky-50 rounded-2xl flex items-center justify-center"></div>
        <div>
            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">System Signal</p>
            <p id="toast-msg" class="text-sm font-black text-slate-800"></p>
        </div>
    </div>

</body>
</html>
