<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KENG2026 Sport Science System</title>
    
    <!-- UI Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Font: Prompt -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        * { font-family: 'Prompt', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f8fafc; overflow-x: hidden; width: 100%; }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ปุ่มสไตล์พรีเมียม */
        .theme-btn { 
            background-color: #0ea5e9; color: white; transition: all 0.2s; 
            border-radius: 12px; display: inline-flex; align-items: center; 
            justify-content: center; gap: 8px; font-weight: 600;
        }
        .theme-btn:active { transform: scale(0.98); }
        
        .classic-card {
            background: white; border: 1px solid #f1f5f9; border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* ป้องกัน Input ตกขอบและ Zoom บน iOS */
        .clean-input {
            background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 0.75rem 1rem; transition: all 0.2s ease; color: #1e293b; 
            width: 100%; font-size: 16px;
        }
        .clean-input:focus { background-color: #ffffff; border-color: #0ea5e9; outline: none; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
        
        .nav-item-active { background-color: #f0f9ff; color: #0ea5e9; font-weight: 700; border-right: 4px solid #0ea5e9; }

        @media print {
            @page { size: A4; margin: 0; }
            body * { visibility: hidden; }
            #report-container, #report-container * { visibility: visible; }
            #report-container {
                position: absolute; left: 0; top: 0; width: 210mm; padding: 15mm;
                background: white; display: block !important; color: black; z-index: 9999;
            }
            .no-print { display: none !important; }
        }

        /* ปรับปรุงระบบ Modal ให้ไม่ล้นจอ */
        .modal-content {
            width: 95%; max-width: 500px; max-height: 90vh;
            overflow-y: auto; border-radius: 24px;
        }
    </style>
</head>
<body class="text-slate-600 antialiased">

    <!-- หน้า Login -->
    <div id="login-view" class="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-sky-500">
        <div class="relative bg-white p-8 max-w-sm w-full rounded-[32px] shadow-2xl text-center">
            <div class="w-16 h-16 bg-sky-500 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-sky-100">
                <i data-lucide="cloud-lightning"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800">Cloud Login</h2>
            <p class="text-slate-400 text-sm mt-1 mb-8">KENG2026 Sport Science</p>
            <div class="space-y-4">
                <input type="password" id="login-pass" class="clean-input text-center" placeholder="รหัสผ่าน" onkeydown="if(event.key==='Enter') App.handleLogin()">
                <button onclick="App.handleLogin()" class="theme-btn w-full py-4 shadow-xl shadow-sky-100 uppercase tracking-wider">เข้าสู่ระบบ</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="main-system" class="flex min-h-screen relative hidden no-print">
        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebar-overlay" onclick="App.toggleSidebar()" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden lg:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-slate-100 flex flex-col transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300">
            <div class="p-6 flex items-center gap-3 border-b">
                <div class="w-10 h-10 bg-sky-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-sky-100">
                    <i data-lucide="zap" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-xl tracking-tight text-slate-800">KENG<span class="text-sky-500">2026</span></span>
            </div>
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto hide-scroll">
                <button onclick="App.setTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i><span class="text-sm font-medium">แดชบอร์ด</span>
                </button>
                <button onclick="App.setTab('patients')" id="nav-patients" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="users" class="w-5 h-5"></i><span class="text-sm font-medium">รายชื่อคนไข้</span>
                </button>
                <button onclick="App.setTab('fitness')" id="nav-fitness" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="calculator" class="w-5 h-5"></i><span class="text-sm font-medium">เครื่องมือแล็บ</span>
                </button>
                <button onclick="App.setTab('form')" id="nav-form" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="user-plus" class="w-5 h-5"></i><span class="text-sm font-medium">เพิ่มข้อมูลใหม่</span>
                </button>
            </nav>
            <div class="p-4 border-t">
                <button onclick="App.logout()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-slate-400 hover:text-red-500 rounded-xl hover:bg-red-50">
                    <i data-lucide="log-out" class="w-4 h-4"></i><span>ออกจากระบบ</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-[#f8fafc]">
            <header class="h-16 bg-white/90 backdrop-blur-md border-b flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
                <div class="flex items-center gap-3">
                    <button onclick="App.toggleSidebar()" class="lg:hidden p-2 text-slate-500"><i data-lucide="menu"></i></button>
                    <h1 id="page-title" class="font-bold text-slate-800 text-lg">Dashboard</h1>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-[10px] font-bold text-emerald-600 uppercase">Cloud Sync</span>
                </div>
            </header>

            <div class="p-4 md:p-6 max-w-7xl mx-auto w-full space-y-6 overflow-x-hidden">
                <!-- Dashboard -->
                <section id="view-dashboard" class="fade-enter space-y-4 md:space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="classic-card p-5 border-l-4 border-l-sky-500">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">จำนวนคนไข้ทั้งหมด</p>
                            <h2 id="stat-total" class="text-3xl font-bold mt-1">0</h2>
                        </div>
                        <div class="classic-card p-5 border-l-4 border-l-emerald-500">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">ค่าเฉลี่ย Max HR</p>
                            <h2 id="stat-avg-hr" class="text-3xl font-bold mt-1">0</h2>
                        </div>
                        <div class="classic-card p-5 border-l-4 border-l-amber-500 sm:col-span-2 lg:col-span-1">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">ค่าเฉลี่ย BMI</p>
                            <h2 id="stat-avg-bmi" class="text-3xl font-bold mt-1">0</h2>
                        </div>
                    </div>
                    <div class="classic-card p-5">
                        <h3 class="font-bold mb-4 flex items-center gap-2 text-slate-800"><i data-lucide="history" class="w-4 h-4 text-sky-500"></i> รายการล่าสุด</h3>
                        <div id="recent-list" class="space-y-3"></div>
                    </div>
                </section>

                <!-- Registry -->
                <section id="view-patients" class="hidden fade-enter space-y-4">
                    <div class="flex flex-col sm:flex-row gap-3 items-center justify-between bg-white p-3 rounded-2xl border shadow-sm sm:bg-transparent sm:p-0 sm:border-0 sm:shadow-none">
                        <input type="text" id="search-input" onkeyup="App.renderTable()" class="clean-input sm:max-w-xs" placeholder="ค้นหาชื่อหรือชื่อเล่น...">
                        <button onclick="App.setTab('form')" class="theme-btn w-full sm:w-auto px-6 py-3 shadow-lg shadow-sky-100 text-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i> เพิ่มข้อมูล
                        </button>
                    </div>

                    <!-- Mobile Cards List -->
                    <div id="patient-mobile-list" class="grid grid-cols-1 gap-4 md:hidden"></div>

                    <!-- Desktop Table -->
                    <div class="classic-card overflow-hidden hidden md:block">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-slate-400 text-[10px] font-bold uppercase tracking-widest border-b">
                                    <tr>
                                        <th class="px-6 py-4">ชื่อ-นามสกุล</th>
                                        <th class="px-6 py-4">ข้อมูลพื้นฐาน</th>
                                        <th class="px-6 py-4">สรุปดัชนี</th>
                                        <th class="px-6 py-4 text-right">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="patient-table-body" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Lab Tools -->
                <section id="view-fitness" class="hidden fade-enter space-y-6">
                    <div class="classic-card p-5 border-t-4 border-t-sky-500">
                        <h3 class="font-bold text-slate-800 mb-2">เชื่อมโยงข้อมูล</h3>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <select id="fit-registry-select" class="clean-input text-sm flex-1"></select>
                            <button onclick="App.loadFromRegistry()" class="theme-btn px-8 py-3 text-sm">ซิงค์ข้อมูล</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Strength -->
                        <div class="classic-card p-5 border-t-4 border-t-rose-500 space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold flex items-center gap-2"><i data-lucide="dumbbell" class="text-rose-500"></i> Strength (1RM)</h3>
                                <label class="flex items-center gap-2 text-[10px] font-bold text-slate-400 uppercase"><input type="checkbox" id="toggle-report-strength" onchange="App.updateReportSettings('strength')" class="w-4 h-4 text-sky-500 rounded"> พิมพ์</label>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <select id="fit-1rm-exercise" class="clean-input text-sm sm:col-span-2" onchange="App.toggleCustomExercise()">
                                    <option>Back Squat</option><option>Bench Press</option><option>Deadlift</option><option value="custom">อื่นๆ (ระบุเอง)</option>
                                </select>
                                <input type="text" id="fit-1rm-custom-name" class="clean-input text-sm sm:col-span-2 hidden" placeholder="ระบุชื่อท่าออกกำลังกาย">
                                <input type="number" id="fit-1rm-weight" class="clean-input text-sm" placeholder="น้ำหนัก (kg)">
                                <input type="number" id="fit-1rm-reps" class="clean-input text-sm" placeholder="จำนวนครั้ง">
                            </div>
                            <button onclick="App.calculateStrength()" class="theme-btn w-full py-3 bg-rose-500 hover:bg-rose-600 text-sm">วิเคราะห์และบันทึก</button>
                            <div id="res-1rm-box" class="hidden p-4 bg-rose-50 rounded-2xl text-center border border-rose-100">
                                <p class="text-[10px] font-bold text-rose-400 uppercase">Estimated 1RM</p>
                                <p id="res-1rm" class="text-4xl font-bold text-rose-600">0 kg</p>
                            </div>
                        </div>

                        <!-- Cardiac -->
                        <div class="classic-card p-5 border-t-4 border-t-emerald-500 space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold flex items-center gap-2"><i data-lucide="heart" class="text-emerald-500"></i> Cardiac Zones</h3>
                                <label class="flex items-center gap-2 text-[10px] font-bold text-slate-400 uppercase"><input type="checkbox" id="toggle-report-cardiac" onchange="App.updateReportSettings('cardiac')" class="w-4 h-4 text-sky-500 rounded"> พิมพ์</label>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" id="fit-hr-age" class="clean-input text-sm" placeholder="อายุ">
                                <input type="number" id="fit-hr-rhr" class="clean-input text-sm" placeholder="Rest HR">
                            </div>
                            <button onclick="App.calculateHR()" class="theme-btn w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-sm">คำนวณโซน</button>
                            <div id="res-hr-zones" class="space-y-2 hidden"></div>
                        </div>
                    </div>
                </section>

                <!-- Form -->
                <section id="view-form" class="hidden fade-enter">
                    <div class="classic-card p-6 md:p-8 max-w-2xl mx-auto">
                        <form id="patient-form" onsubmit="event.preventDefault(); App.savePatient();" class="space-y-6">
                            <input type="hidden" id="p-edit-id">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="sm:col-span-2"><label class="text-xs font-bold text-slate-400 mb-1 block uppercase">ชื่อ-นามสกุล</label><input type="text" id="p-name" required class="clean-input font-bold" placeholder="ระบุชื่อจริง"></div>
                                <div><label class="text-xs font-bold text-slate-400 mb-1 block uppercase">ชื่อเล่น</label><input type="text" id="p-nickname" class="clean-input" placeholder="ถ้ามี"></div>
                                <div><label class="text-xs font-bold text-slate-400 mb-1 block uppercase">เพศ</label><select id="p-gender" class="clean-input bg-white"><option value="ชาย">ชาย</option><option value="หญิง">หญิง</option></select></div>
                                <div><label class="text-xs font-bold text-slate-400 mb-1 block uppercase">น้ำหนัก (kg)</label><input type="number" id="p-weight" step="0.1" class="clean-input" placeholder="0.0"></div>
                                <div><label class="text-xs font-bold text-slate-400 mb-1 block uppercase">ส่วนสูง (cm)</label><input type="number" id="p-height" class="clean-input" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-400 mb-1 block uppercase">อายุ</label><input type="number" id="p-age" class="clean-input" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-400 mb-1 block uppercase">Rest HR</label><input type="number" id="p-rhr" class="clean-input" placeholder="0"></div>
                                <div class="sm:col-span-2"><label class="text-xs font-bold text-slate-400 mb-1 block uppercase">หมายเหตุเพิ่มเติม</label><textarea id="p-note" rows="3" class="clean-input resize-none" placeholder="ข้อมูลสุขภาพเบื้องต้น..."></textarea></div>
                            </div>
                            <div class="pt-4 flex flex-col sm:flex-row gap-3">
                                <button type="submit" class="theme-btn flex-1 py-4 text-sm shadow-lg shadow-sky-100 uppercase tracking-widest">บันทึกข้อมูลเข้า Cloud</button>
                                <button type="button" onclick="App.setTab('patients')" class="flex-1 py-4 rounded-xl text-sm font-bold text-slate-400 hover:text-slate-600 bg-slate-50">ยกเลิก</button>
                            </div>
                        </form>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="report-container" class="hidden"></div>
    <div id="profile-modal" class="fixed inset-0 z-[150] hidden items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white modal-content p-6 shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">ข้อมูลส่วนตัว</h3>
                <div class="flex gap-1">
                    <button id="modal-print-btn" class="p-2 text-slate-400 hover:text-sky-500"><i data-lucide="printer"></i></button>
                    <button onclick="App.closeProfileModal()" class="p-2 text-slate-400"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div id="profile-content" class="flex-1 space-y-4"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-4 rounded-2xl shadow-2xl translate-y-32 transition-all duration-500 flex items-center gap-4 z-[400] w-[90%] max-w-xs">
        <div id="toast-icon" class="text-emerald-400"><i data-lucide="check-circle"></i></div>
        <p id="toast-msg" class="text-sm font-medium"></p>
    </div>

    <script>
        const App = {
            db: null,
            patients: [],
            activeTab: 'dashboard',
            deleteId: null,

            async init() {
                // --- ส่วนที่ต้องแก้ไข: ใส่ค่าจาก FIREBASE ของคุณตรงนี้ ---
               // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDfsxH5h_G5qLUAMEB1RLRjpHTy-yacvvY",
  authDomain: "fitness-1414f.firebaseapp.com",
  projectId: "fitness-1414f",
  storageBucket: "fitness-1414f.firebasestorage.app",
  messagingSenderId: "778205778078",
  appId: "1:778205778078:web:c4af1300f1611ad9576b8f",
  measurementId: "G-MFRGX1S4QJ"
};

                if(firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.log("กรุณาใส่ Firebase Config ในโค้ดก่อนใช้งาน");
                    return;
                }

                try {
                    firebase.initializeApp(firebaseConfig);
                    this.db = firebase.firestore();
                    this.db.collection("patients").orderBy("updatedAt", "desc").onSnapshot((snapshot) => {
                        this.patients = [];
                        snapshot.forEach((doc) => { this.patients.push(doc.data()); });
                        this.refreshUI();
                    });
                    lucide.createIcons();
                    if (localStorage.getItem('keng_session') === 'active') this.showMain();
                } catch (e) { console.error(e); }
            },

            refreshUI() {
                if(this.activeTab === 'dashboard') this.updateDash();
                if(this.activeTab === 'patients') this.renderTable();
                if(this.activeTab === 'fitness') this.populateSync();
            },

            handleLogin() {
                const p = document.getElementById('login-pass').value;
                if (p === 'korntawat') { localStorage.setItem('keng_session', 'active'); this.showMain(); }
                else { this.toast("รหัสผ่านไม่ถูกต้อง", "shield-off"); }
            },

            showMain() {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-system').classList.remove('hidden');
                this.setTab('dashboard');
            },

            logout() { localStorage.removeItem('keng_session'); location.reload(); },

            setTab(t) {
                this.activeTab = t;
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById(`view-${t}`).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('nav-item-active'));
                const nav = document.getElementById(`nav-${t}`); if(nav) nav.classList.add('nav-item-active');
                
                const titles = { 'dashboard': 'แดชบอร์ด', 'patients': 'รายชื่อคนไข้', 'fitness': 'เครื่องมือแล็บ', 'form': 'จัดการข้อมูล' };
                document.getElementById('page-title').innerText = titles[t] || 'Dashboard';
                
                this.refreshUI();
                if (window.innerWidth < 1024) this.toggleSidebar(false);
                lucide.createIcons();
            },

            toggleSidebar(force) {
                const s = document.getElementById('sidebar');
                const o = document.getElementById('sidebar-overlay');
                const isHidden = s.classList.contains('-translate-x-full');
                const nextState = force !== undefined ? force : isHidden;
                
                if (nextState) { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); } 
                else { s.classList.add('-translate-x-full'); o.classList.add('hidden'); }
            },

            async savePatient() {
                const id = document.getElementById('p-edit-id').value;
                const n = document.getElementById('p-name').value;
                if(!n) return;
                
                const docId = id ? id : Date.now().toString();
                const w = parseFloat(document.getElementById('p-weight').value)||0;
                const h = parseFloat(document.getElementById('p-height').value)||0;
                const a = parseInt(document.getElementById('p-age').value)||0;

                const data = {
                    id: parseInt(docId),
                    name: n,
                    nickname: document.getElementById('p-nickname').value,
                    gender: document.getElementById('p-gender').value,
                    weight: w, height: h, age: a,
                    rhr: parseInt(document.getElementById('p-rhr').value)||0,
                    note: document.getElementById('p-note').value,
                    bmi: (w>0&&h>0)?(w/((h/100)**2)).toFixed(1):'0.0',
                    maxHR: a>0?(208-0.7*a).toFixed(0):'0',
                    updatedAt: Date.now()
                };

                try {
                    await this.db.collection("patients").doc(docId).set(data, { merge: true });
                    this.toast("บันทึกข้อมูลเรียบร้อย", "cloud-upload");
                    this.resetForm();
                    this.setTab('patients');
                } catch(e) { this.toast("บันทึกผิดพลาด", "alert-circle"); }
            },

            // --- Lab Calculations ---
            calculateStrength() {
                const w = parseFloat(document.getElementById('fit-1rm-weight').value) || 0;
                const r = parseInt(document.getElementById('fit-1rm-reps').value) || 0;
                let ex = document.getElementById('fit-1rm-exercise').value;
                if (ex === 'custom') ex = document.getElementById('fit-1rm-custom-name').value.trim() || 'Custom';
                if(w <= 0 || r <= 0) return;
                const max = (w * (1 + r/30)).toFixed(1);
                document.getElementById('res-1rm').innerText = `${max} kg`;
                document.getElementById('res-1rm-box').classList.remove('hidden');
                
                const id = document.getElementById('fit-registry-select').value;
                if(id) {
                    const p = this.patients.find(i => i.id == id);
                    if(p) {
                        const recs = p.records ? [...p.records] : [];
                        recs.push({ date: new Date().toISOString(), exercise: ex, weight: w, reps: r, oneRM: max });
                        this.db.collection("patients").doc(id).update({ records: recs });
                        this.toast("บันทึกสถิติ Strength แล้ว", "check");
                    }
                }
            },

            calculateHR() {
                const a = parseInt(document.getElementById('fit-hr-age').value)||0, r = parseInt(document.getElementById('fit-hr-rhr').value)||0;
                if(a<=0) return;
                const box = document.getElementById('res-hr-zones'); box.innerHTML = ''; box.classList.remove('hidden');
                const mhr = 208 - (0.7*a), hrr = r > 30 ? mhr-r : mhr, base = r > 30 ? r : 0;
                const zones = [{n:"Z1 Recovery",p:[0.5,0.6],c:"bg-slate-50 text-slate-600"},{n:"Z2 Aerobic",p:[0.6,0.7],c:"bg-emerald-50 text-emerald-700"},{n:"Z3 Tempo",p:[0.7,0.8],c:"bg-sky-50 text-sky-700"},{n:"Z4 Anaerobic",p:[0.8,0.9],c:"bg-orange-50 text-orange-700"},{n:"Z5 Maximum",p:[0.9,1.0],c:"bg-rose-50 text-rose-700"}];
                let saved = [];
                zones.forEach(z => {
                    const low = Math.round(hrr*z.p[0]+base), high = Math.round(hrr*z.p[1]+base);
                    saved.push({ name: z.n, range: `${low}-${high} bpm` });
                    box.innerHTML += `<div class="p-3 rounded-xl flex justify-between font-bold text-xs ${z.c}"><span>${z.n}</span><span>${low}-${high} bpm</span></div>`;
                });
                const id = document.getElementById('fit-registry-select').value;
                if(id) {
                    this.db.collection("patients").doc(id).update({ age: a, rhr: r, maxHR: Math.round(mhr), zones: saved });
                    this.toast("บันทึกข้อมูล HR แล้ว", "heart");
                }
            },

            // --- UI Rendering ---
            updateDash() {
                const bmis = this.patients.map(p => parseFloat(p.bmi)).filter(v => !isNaN(v));
                const hrs = this.patients.map(p => parseInt(p.maxHR)).filter(v => !isNaN(v));
                document.getElementById('stat-total').innerText = this.patients.length;
                document.getElementById('stat-avg-bmi').innerText = bmis.length ? (bmis.reduce((a,b)=>a+b,0)/bmis.length).toFixed(1) : "0";
                document.getElementById('stat-avg-hr').innerText = hrs.length ? Math.round(hrs.reduce((a,b)=>a+b,0)/hrs.length) : "0";
                const list = document.getElementById('recent-list'); list.innerHTML = '';
                this.patients.slice(0,3).forEach(p => {
                    list.innerHTML += `<div class="flex justify-between p-4 bg-slate-50 rounded-xl items-center border"><div><p class="font-bold text-slate-800 text-sm">${p.name}</p><p class="text-[10px] text-slate-400 font-bold uppercase">${p.nickname || 'ไม่มีชื่อเล่น'}</p></div><span class="px-3 py-1 bg-white border rounded-lg text-xs font-bold text-sky-600">BMI ${p.bmi}</span></div>`;
                });
            },

            renderTable() {
                const tbody = document.getElementById('patient-table-body');
                const mList = document.getElementById('patient-mobile-list');
                const s = document.getElementById('search-input').value.toLowerCase();
                tbody.innerHTML = ''; mList.innerHTML = '';
                
                const filtered = this.patients.filter(p => p.name.toLowerCase().includes(s) || (p.nickname && p.nickname.toLowerCase().includes(s)));
                
                if(filtered.length === 0) document.getElementById('empty-state').classList.remove('hidden');
                else {
                    document.getElementById('empty-state').classList.add('hidden');
                    filtered.forEach(p => {
                        const latest = p.records?.length ? p.records[p.records.length-1] : null;
                        
                        // Desktop
                        tbody.innerHTML += `
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-6 py-4 font-bold text-sm text-slate-800">${p.name}<p class="text-[10px] text-slate-400 font-bold">${p.nickname || ''}</p></td>
                                <td class="px-6 py-4 text-xs font-bold text-slate-500 uppercase">${p.gender} • ${p.age} ปี</td>
                                <td class="px-6 py-4"><div class="flex gap-2"><span class="px-2 py-1 bg-sky-50 text-sky-600 rounded-md text-[10px] font-bold">BMI ${p.bmi}</span>${latest ? `<span class="px-2 py-1 bg-rose-50 text-rose-600 rounded-md text-[10px] font-bold">1RM ${latest.oneRM}kg</span>` : ''}</div></td>
                                <td class="px-6 py-4 text-right space-x-1">
                                    <button onclick="App.viewProfile('${p.id}')" class="p-2 text-slate-300 hover:text-emerald-500"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                    <button onclick="App.printReport('${p.id}')" class="p-2 text-slate-300 hover:text-indigo-500"><i data-lucide="printer" class="w-4 h-4"></i></button>
                                    <button onclick="App.editPatient('${p.id}')" class="p-2 text-slate-300 hover:text-sky-500"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                </td>
                            </tr>`;
                            
                        // Mobile
                        mList.innerHTML += `
                            <div class="bg-white p-5 rounded-2xl border shadow-sm space-y-4">
                                <div class="flex justify-between items-start">
                                    <div><h4 class="font-bold text-slate-800">${p.name}</h4><p class="text-xs text-slate-400 font-bold uppercase">${p.nickname || 'ไม่มีชื่อเล่น'}</p></div>
                                    <span class="px-2 py-1 bg-sky-50 text-sky-600 rounded-md text-[10px] font-bold">BMI ${p.bmi}</span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 border-t pt-3">
                                    <button onclick="App.viewProfile('${p.id}')" class="flex flex-col items-center gap-1 py-2 bg-slate-50 rounded-xl text-slate-500"><i data-lucide="eye" class="w-4 h-4"></i><span class="text-[9px] font-bold">ดูโปรไฟล์</span></button>
                                    <button onclick="App.printReport('${p.id}')" class="flex flex-col items-center gap-1 py-2 bg-slate-50 rounded-xl text-slate-500"><i data-lucide="printer" class="w-4 h-4"></i><span class="text-[9px] font-bold">พิมพ์ PDF</span></button>
                                    <button onclick="App.editPatient('${p.id}')" class="flex flex-col items-center gap-1 py-2 bg-slate-50 rounded-xl text-slate-500"><i data-lucide="edit-3" class="w-4 h-4"></i><span class="text-[9px] font-bold">แก้ไข</span></button>
                                </div>
                            </div>`;
                    });
                }
                lucide.createIcons();
            },

            populateSync() {
                const sel = document.getElementById('fit-registry-select'); 
                sel.innerHTML = '<option value="">เลือกคนไข้จากระบบ...</option>';
                this.patients.forEach(p => { sel.innerHTML += `<option value="${p.id}">${p.name} (${p.nickname || 'ไม่มีชื่อเล่น'})</option>`; });
            },

            loadFromRegistry() {
                const id = document.getElementById('fit-registry-select').value; if(!id) return;
                const p = this.patients.find(i => i.id == id);
                if(p) {
                    ['fit-weight','fit-height','fit-age','fit-hr-age','fit-hr-rhr'].forEach(el => {
                        const input = document.getElementById(el);
                        if(input) input.value = p[el.split('-')[1]] || p.age || '';
                    });
                    document.getElementById('fit-gender').value = p.gender || 'ชาย';
                    this.toast(`ซิงค์ข้อมูล ${p.name} สำเร็จ`, "refresh-cw");
                }
            },

            viewProfile(id) {
                const p = this.patients.find(i => i.id == id); if(!p) return;
                const content = document.getElementById('profile-content');
                document.getElementById('modal-print-btn').onclick = () => App.printReport(id);
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border">
                            <div class="w-14 h-14 bg-sky-500 text-white rounded-2xl flex items-center justify-center font-bold text-2xl">${p.name[0]}</div>
                            <div><h4 class="font-bold text-slate-800">${p.name}</h4><p class="text-xs font-bold text-slate-400 uppercase">${p.nickname || '-'} • ${p.gender} • ${p.age} ปี</p></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-center">
                            <div class="bg-white border rounded-2xl p-3"><p class="text-[9px] font-bold text-slate-400 uppercase">Weight</p><p class="text-xl font-bold">${p.weight}kg</p></div>
                            <div class="bg-white border rounded-2xl p-3"><p class="text-[9px] font-bold text-slate-400 uppercase">Height</p><p class="text-xl font-bold">${p.height}cm</p></div>
                            <div class="bg-sky-50 border border-sky-100 rounded-2xl p-3 col-span-2"><p class="text-[9px] font-bold text-sky-400 uppercase">Body Mass Index (BMI)</p><p class="text-2xl font-bold text-sky-600">${p.bmi}</p></div>
                        </div>
                        <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">หมายเหตุ</p><p class="text-sm p-4 bg-slate-50 rounded-xl border italic">${p.note || 'ไม่มีข้อมูลเพิ่มเติม'}</p></div>
                    </div>`;
                document.getElementById('profile-modal').classList.replace('hidden', 'flex');
                lucide.createIcons();
            },

            printReport(id) {
                const p = this.patients.find(i => i.id == id); if (!p) return;
                const settings = p.reportSettings || { strength: true, cardiac: true };
                const container = document.getElementById('report-container');
                
                const zonesHtml = p.zones?.length ? `<table class="report-table"><thead><tr><th>Zone</th><th style="text-align:right">Range (bpm)</th></tr></thead><tbody>${p.zones.map(z => `<tr><td>${z.name}</td><td style="text-align:right">${z.range}</td></tr>`).join('')}</tbody></table>` : '';
                const recordsHtml = p.records?.length ? `<table class="report-table"><thead><tr><th>Date</th><th>ท่า</th><th>โหลด</th><th style="text-align:right">1RM</th></tr></thead><tbody>${p.records.slice().reverse().map(r => `<tr><td>${new Date(r.date).toLocaleDateString('th-TH')}</td><td>${r.exercise}</td><td>${r.weight}kg x ${r.reps}</td><td style="text-align:right">${r.oneRM} kg</td></tr>`).join('')}</tbody></table>` : '';

                container.innerHTML = `
                    <div style="border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end;">
                        <div><h1 style="font-size: 24pt; font-weight: 700; margin: 0;">SPORT SCIENCE REPORT</h1><p style="font-size: 10pt; color: #666; margin: 5px 0 0 0;">KENG2026 Management System</p></div>
                        <div style="text-align: right;"><p style="font-size: 8pt; margin: 0;">Issue Date: <strong>${new Date().toLocaleDateString('th-TH')}</strong></p></div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 10px;">
                            <p style="font-size: 8pt; color: #888; margin: 0;">Name:</p><p style="font-size: 14pt; font-weight: 700; margin: 0;">${p.name}</p>
                            <p style="font-size: 9pt; font-weight: 600; margin: 5px 0 0 0;">Nickname: ${p.nickname || '-'} • ${p.age}Y • ${p.gender}</p>
                        </div>
                        <div style="border: 1px solid #eee; padding: 15px; border-radius: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;">
                            <div><span style="font-size: 7pt; color: #888; display: block;">Weight</span><strong>${p.weight}kg</strong></div>
                            <div><span style="font-size: 7pt; color: #888; display: block;">Height</span><strong>${p.height}cm</strong></div>
                            <div><span style="font-size: 7pt; color: #888; display: block;">BMI</span><strong style="color: #0ea5e9;">${p.bmi}</strong></div>
                        </div>
                    </div>
                    ${settings.cardiac && zonesHtml ? `<div style="margin-bottom: 20px;"><h3>Target Heart Rate Zones</h3>${zonesHtml}</div>` : ''}
                    ${settings.strength && recordsHtml ? `<div><h3>Strength Progress (1-Rep Max)</h3>${recordsHtml}</div>` : ''}
                    <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px; font-size: 8pt; color: #999;">
                        Note: ${p.note || '-'}
                        <div style="margin-top: 40px; text-align: center; color: #ccc;">--- Generated by KENG2026 Cloud System ---</div>
                    </div>`;

                // เปลี่ยนชื่อไฟล์สำหรับพิมพ์
                const originalTitle = document.title;
                const dateStr = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                document.title = `${p.name}_${dateStr}`;
                window.print();
                document.title = originalTitle;
            },

            closeProfileModal() { document.getElementById('profile-modal').classList.replace('flex', 'hidden'); },
            editPatient(id) {
                const p = this.patients.find(i => i.id == id);
                if(p) {
                    ['p-name', 'p-nickname', 'p-weight', 'p-height', 'p-age', 'p-rhr', 'p-note'].forEach(el => document.getElementById(el).value = p[el.split('-')[1]] || '');
                    document.getElementById('p-gender').value = p.gender; document.getElementById('p-edit-id').value = p.id; this.setTab('form');
                }
            },
            resetForm() { document.getElementById('patient-form').reset(); document.getElementById('p-edit-id').value = ''; },
            toggleCustomExercise() { const isCustom = document.getElementById('fit-1rm-exercise').value === 'custom'; document.getElementById('fit-1rm-custom-name').classList.toggle('hidden', !isCustom); },
            toast(m, i) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; document.getElementById('toast-icon').innerHTML = `<i data-lucide="${i}"></i>`; lucide.createIcons(); t.classList.remove('translate-y-32'); setTimeout(() => t.classList.add('translate-y-32'), 3000); }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
