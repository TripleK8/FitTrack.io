<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KENG2026 Sport Science System v2.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK v11 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global App State
        window.App = {
            db: null,
            auth: null,
            user: null,
            patients: [],
            activeTab: 'dashboard',
            appId: typeof __app_id !== 'undefined' ? __app_id : 'keng2026-sport-sci',

            async init() {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                this.auth = getAuth(app);
                this.db = getFirestore(app);

                // Auth Handling
                onAuthStateChanged(this.auth, (user) => {
                    if (user) {
                        this.user = user;
                        this.setupListeners();
                    } else {
                        signInAnonymously(this.auth);
                    }
                });

                lucide.createIcons();
                if (localStorage.getItem('keng_session') === 'active') this.showMain();
            },

            setupListeners() {
                if (!this.user) return;
                const q = query(collection(this.db, 'artifacts', this.appId, 'public', 'data', 'patients'), orderBy('updatedAt', 'desc'));
                onSnapshot(q, (snapshot) => {
                    this.patients = [];
                    snapshot.forEach((doc) => this.patients.push({ ...doc.data(), id: doc.id }));
                    this.refreshUI();
                }, (err) => console.error("Firestore Error:", err));
            },

            refreshUI() {
                this.updateDash();
                this.renderTable();
                this.populateSyncDropdown();
                lucide.createIcons();
            },

            // --- UI Navigation ---
            setTab(t) {
                this.activeTab = t;
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById(`view-${t}`).classList.remove('hidden');
                
                // Update Nav UI
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('sidebar-item-active'));
                document.getElementById(`nav-${t}`).classList.add('sidebar-item-active');
                
                const titles = { 'dashboard': 'Overview', 'patients': 'Registry', 'fitness': 'Lab Tools', 'form': 'New Entry' };
                document.getElementById('page-title').innerText = titles[t] || 'Dashboard';
                lucide.createIcons();
            },

            // --- Dashboard Logic ---
            updateDash() {
                document.getElementById('stat-total').innerText = this.patients.length;
                const bmis = this.patients.map(p => parseFloat(p.bmi)).filter(v => !isNaN(v));
                document.getElementById('stat-avg-bmi').innerText = bmis.length ? (bmis.reduce((a,b)=>a+b,0)/bmis.length).toFixed(1) : "0";
                
                const list = document.getElementById('recent-list');
                list.innerHTML = this.patients.slice(0, 5).map(p => `
                    <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl shadow-sm hover:shadow-md transition-all cursor-pointer" onclick="App.viewPatient('${p.id}')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center font-bold">${p.name.charAt(0)}</div>
                            <div>
                                <p class="font-bold text-slate-800 text-sm">${p.name}</p>
                                <p class="text-[10px] text-slate-400 uppercase font-black tracking-tighter">${p.nickname || 'No Alias'}</p>
                            </div>
                        </div>
                        <span class="metric-badge">BMI ${p.bmi || '-'}</span>
                    </div>
                `).join('') || '<p class="text-center text-slate-400 py-4 text-xs font-bold italic">No data available</p>';
            },

            // --- Registry Table ---
            renderTable() {
                const search = document.getElementById('search-input').value.toLowerCase();
                const tbody = document.getElementById('patient-table-body');
                const filtered = this.patients.filter(p => p.name.toLowerCase().includes(search) || (p.nickname && p.nickname.toLowerCase().includes(search)));
                
                tbody.innerHTML = filtered.map(p => `
                    <tr class="hover:bg-slate-50/50 transition-colors group">
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-800">${p.name}</div>
                            <div class="text-[10px] text-slate-400 font-black uppercase">${p.nickname || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <span class="px-2 py-1 bg-slate-100 rounded text-[10px] font-bold text-slate-600">${p.age}Y</span>
                                <span class="px-2 py-1 bg-sky-50 rounded text-[10px] font-bold text-sky-600">BMI ${p.bmi}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="App.viewPatient('${p.id}')" class="p-2 text-slate-400 hover:text-sky-500 hover:bg-sky-50 rounded-lg transition-all" title="Quick View"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                <button onclick="App.editPatient('${p.id}')" class="p-2 text-slate-400 hover:text-amber-500 hover:bg-amber-50 rounded-lg transition-all" title="Edit"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="App.deletePatient('${p.id}')" class="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                lucide.createIcons();
            },

            // --- Patient Operations ---
            async savePatient() {
                if (!this.user) return;
                const id = document.getElementById('p-edit-id').value || crypto.randomUUID();
                const w = parseFloat(document.getElementById('p-weight').value) || 0;
                const h = parseFloat(document.getElementById('p-height').value) || 0;
                
                const data = {
                    name: document.getElementById('p-name').value,
                    nickname: document.getElementById('p-nickname').value,
                    weight: w,
                    height: h,
                    age: parseInt(document.getElementById('p-age').value) || 0,
                    rhr: parseInt(document.getElementById('p-rhr').value) || 0,
                    note: document.getElementById('p-note').value,
                    bmi: h > 0 ? (w / ((h / 100) ** 2)).toFixed(1) : 0,
                    updatedAt: Date.now()
                };

                try {
                    await setDoc(doc(this.db, 'artifacts', this.appId, 'public', 'data', 'patients', id), data, { merge: true });
                    this.toast("Record Synchronized to Cloud", "cloud-check");
                    this.resetForm();
                    this.setTab('patients');
                } catch (e) {
                    this.toast("Sync Failed", "alert-circle");
                }
            },

            editPatient(id) {
                const p = this.patients.find(i => i.id === id);
                if (!p) return;
                document.getElementById('p-edit-id').value = p.id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-nickname').value = p.nickname || '';
                document.getElementById('p-weight').value = p.weight;
                document.getElementById('p-height').value = p.height;
                document.getElementById('p-age').value = p.age;
                document.getElementById('p-rhr').value = p.rhr;
                document.getElementById('p-note').value = p.note || '';
                this.setTab('form');
            },

            async deletePatient(id) {
                if (!confirm("Confirm deletion from Cloud? This cannot be undone.")) return;
                try {
                    await deleteDoc(doc(this.db, 'artifacts', this.appId, 'public', 'data', 'patients', id));
                    this.toast("Entry Deleted", "trash");
                } catch (e) {
                    this.toast("Delete Failed", "x-circle");
                }
            },

            viewPatient(id) {
                const p = this.patients.find(i => i.id === id);
                if (!p) return;
                
                const modal = document.getElementById('profile-modal');
                const content = document.getElementById('profile-content');
                
                content.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-sky-500 text-white rounded-2xl flex items-center justify-center text-2xl font-black shadow-lg shadow-sky-100">${p.name.charAt(0)}</div>
                            <div>
                                <h2 class="text-2xl font-black text-slate-800 tracking-tighter">${p.name}</h2>
                                <p class="text-sm font-bold text-sky-500 uppercase tracking-widest">${p.nickname || 'No Alias'}</p>
                            </div>
                        </div>
                        <button onclick="App.closeModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x"></i></button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[9px] font-black text-slate-400 uppercase">Age</p>
                            <p class="text-lg font-bold text-slate-700">${p.age}Y</p>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[9px] font-black text-slate-400 uppercase">BMI</p>
                            <p class="text-lg font-bold text-slate-700">${p.bmi}</p>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[9px] font-black text-slate-400 uppercase">Weight</p>
                            <p class="text-lg font-bold text-slate-700">${p.weight}kg</p>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                            <p class="text-[9px] font-black text-slate-400 uppercase">RHR</p>
                            <p class="text-lg font-bold text-slate-700">${p.rhr} bpm</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Lab Summary Sections -->
                        ${this.renderPeakLabSection(p)}
                        
                        <div class="p-4 bg-slate-900 rounded-2xl text-white">
                            <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Internal Note</h4>
                            <p class="text-xs italic leading-relaxed text-slate-300">${p.note || 'No specialist notes recorded for this entry.'}</p>
                        </div>
                    </div>

                    <div class="mt-8 flex gap-3">
                        <button onclick="App.editPatient('${p.id}'); App.closeModal();" class="flex-1 theme-btn py-3 text-xs font-black uppercase tracking-widest">Edit Entry</button>
                        <button onclick="window.print();" class="px-6 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all text-xs uppercase tracking-widest"><i data-lucide="printer" class="w-4 h-4 inline mr-1"></i> Print</button>
                    </div>
                `;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                lucide.createIcons();
            },

            renderPeakLabSection(p) {
                let html = '';
                
                // Cardiovascular
                if (p.maxHR) {
                    html += `
                        <div class="border-l-4 border-emerald-500 pl-4 py-1">
                            <h4 class="text-xs font-black uppercase text-slate-800">Cardiac Profile</h4>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <p class="text-[10px] font-bold text-slate-500">Max HR: <span class="text-emerald-600">${p.maxHR} bpm</span></p>
                                <p class="text-[10px] font-bold text-slate-500">VO2 Peak: <span class="text-emerald-600">${p.vdot || '-'}</span></p>
                            </div>
                        </div>
                    `;
                }

                // Metabolic
                if (p.bmr) {
                    html += `
                        <div class="border-l-4 border-amber-500 pl-4 py-1">
                            <h4 class="text-xs font-black uppercase text-slate-800">Metabolic Lab</h4>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <p class="text-[10px] font-bold text-slate-500">BMR: <span class="text-amber-600">${p.bmr} kcal</span></p>
                                <p class="text-[10px] font-bold text-slate-500">TDEE: <span class="text-amber-600">${p.tdee} kcal</span></p>
                            </div>
                        </div>
                    `;
                }

                // Strength
                if (p.records && p.records.length > 0) {
                    const last = p.records[p.records.length - 1];
                    html += `
                        <div class="border-l-4 border-rose-500 pl-4 py-1">
                            <h4 class="text-xs font-black uppercase text-slate-800">Strength (Last 1RM)</h4>
                            <p class="text-[11px] font-bold text-slate-500 mt-2">${last.exercise}: <span class="text-rose-600">${last.oneRM} kg</span></p>
                        </div>
                    `;
                }

                return html || '<p class="text-center text-[10px] text-slate-400 font-bold uppercase py-4 bg-slate-50 rounded-xl">No Lab Data Synchronized</p>';
            },

            // --- Lab Tools Logic (Inherited & Refined) ---
            calculateMetabolic() {
                const w = parseFloat(document.getElementById('fit-weight').value)||0, 
                      h = parseFloat(document.getElementById('fit-height').value)||0, 
                      a = parseInt(document.getElementById('fit-age').value)||0, 
                      g = document.getElementById('fit-gender').value, 
                      act = parseFloat(document.getElementById('fit-activity').value);
                
                if(w<=0||h<=0||a<=0) return;
                const bmr = (10*w) + (6.25*h) - (5*a) + (g === 'male' ? 5 : -161);
                const tdee = bmr * act;
                
                document.getElementById('res-bmr').innerText = Math.round(bmr);
                document.getElementById('res-tdee').innerText = Math.round(tdee);

                const id = document.getElementById('fit-registry-select').value;
                if(id) this.updatePatientData(id, { weight: w, height: h, age: a, gender: g, activityLevel: act, bmr: Math.round(bmr), tdee: Math.round(tdee) });
                this.toast("Metabolic Stats Saved", "zap");
            },

            calculateHR() {
                const a = parseInt(document.getElementById('fit-hr-age').value)||0, 
                      r = parseInt(document.getElementById('fit-hr-rhr').value)||0;
                if(a <= 0 || r <= 0) return;
                const mhr = 208 - (0.7 * a); 
                const hrr = mhr - r;
                const box = document.getElementById('res-hr-zones'); box.innerHTML = ''; box.classList.remove('hidden');

                const zones = [
                    {n:"Zone 2 (Light)", p:[0.6,0.7], c:"bg-sky-50 text-sky-700"},
                    {n:"Zone 4 (Hard)", p:[0.8,0.9], c:"bg-orange-50 text-orange-700"},
                    {n:"Zone 5 (Max)", p:[0.9,1.0], c:"bg-rose-50 text-rose-700"}
                ];

                zones.forEach(z => {
                    const low = Math.round((hrr * z.p[0]) + r), high = Math.round((hrr * z.p[1]) + r);
                    box.innerHTML += `<div class="p-2 rounded-lg ${z.c} border flex justify-between font-bold text-[10px]"><span>${z.n}</span><span>${low}-${high}</span></div>`;
                });

                const id = document.getElementById('fit-registry-select').value;
                if(id) this.updatePatientData(id, { age: a, rhr: r, maxHR: Math.round(mhr) });
                this.toast("Cardiac Mapping Ready", "heart");
            },

            async updatePatientData(id, newData) {
                if (!this.user) return;
                await updateDoc(doc(this.db, 'artifacts', this.appId, 'public', 'data', 'patients', id), { ...newData, updatedAt: Date.now() });
            },

            // --- Helpers ---
            populateSyncDropdown() {
                const sel = document.getElementById('fit-registry-select');
                const val = sel.value;
                sel.innerHTML = '<option value="">Select Athlete Profile...</option>' + 
                    this.patients.map(p => `<option value="${p.id}" ${p.id === val ? 'selected' : ''}>${p.name}</option>`).join('');
            },

            loadFromRegistry() {
                const id = document.getElementById('fit-registry-select').value;
                const p = this.patients.find(i => i.id === id);
                if(p) {
                    document.getElementById('fit-weight').value = p.weight;
                    document.getElementById('fit-height').value = p.height;
                    document.getElementById('fit-age').value = p.age;
                    document.getElementById('fit-hr-age').value = p.age;
                    document.getElementById('fit-hr-rhr').value = p.rhr;
                    this.toast(`Profile Loaded: ${p.name}`, "user");
                }
            },

            handleLogin() {
                if (document.getElementById('login-pass').value === 'korntawat') {
                    localStorage.setItem('keng_session', 'active');
                    this.showMain();
                } else {
                    this.toast("Unauthorized Access", "shield-off");
                }
            },

            showMain() {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-system').classList.remove('hidden');
                this.setTab('dashboard');
                this.init();
            },

            logout() {
                localStorage.removeItem('keng_session');
                location.reload();
            },

            closeModal() {
                document.getElementById('profile-modal').classList.add('hidden');
                document.getElementById('profile-modal').classList.remove('flex');
            },

            toast(m, i) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = m;
                document.getElementById('toast-icon').innerHTML = `<i data-lucide="${i}" class="w-5 h-5 text-sky-500"></i>`;
                lucide.createIcons();
                t.classList.remove('translate-y-32', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
            },

            resetForm() {
                document.getElementById('patient-form').reset();
                document.getElementById('p-edit-id').value = '';
            },

            toggleSidebar() {
                document.getElementById('sidebar').classList.toggle('-translate-x-full');
            }
        };

        window.onload = () => App.init();
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .theme-btn { 
            background: #0ea5e9; color: white; border-radius: 12px; 
            transition: all 0.2s; border: none; cursor: pointer;
        }
        .theme-btn:hover { background: #0284c7; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2); }
        .theme-btn:active { transform: translateY(0); }
        
        .classic-card { background: white; border-radius: 24px; border: 1px solid #f1f5f9; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .sidebar-item-active { background-color: #f0f9ff; color: #0ea5e9; font-weight: 700; border-right: 4px solid #0ea5e9; }
        
        .clean-input {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 0.75rem 1rem; transition: all 0.2s; width: 100%; font-size: 0.875rem;
        }
        .clean-input:focus { background: white; border-color: #0ea5e9; outline: none; box-shadow: 0 0 0 3px rgba(14,165,233,0.1); }
        
        .metric-badge { background: #f1f5f9; color: #475569; padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-enter { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="text-slate-600 antialiased overflow-hidden">

    <!-- Login Layer -->
    <div id="login-view" class="fixed inset-0 z-[500] flex items-center justify-center p-4 bg-slate-900 overflow-hidden">
        <div class="relative bg-white p-10 max-w-sm w-full rounded-[40px] shadow-2xl text-center">
            <div class="w-20 h-20 bg-sky-500 text-white rounded-3xl flex items-center justify-center shadow-xl shadow-sky-200 mx-auto mb-8">
                <i data-lucide="activity" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-black text-slate-800 tracking-tighter">KENG 2026</h2>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mt-1 mb-8">Cloud Performance Lab</p>
            <div class="space-y-4">
                <input type="password" id="login-pass" class="clean-input text-center font-bold tracking-widest" placeholder="••••••••" onkeydown="if(event.key==='Enter') App.handleLogin()">
                <button onclick="App.handleLogin()" class="theme-btn w-full py-4 font-black uppercase text-xs tracking-widest">Authorize Access</button>
            </div>
        </div>
    </div>

    <!-- Main System UI -->
    <div id="main-system" class="flex h-screen relative hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-slate-100 flex flex-col transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300">
            <div class="p-8 flex items-center gap-3">
                <div class="w-10 h-10 bg-sky-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-sky-100">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                </div>
                <span class="font-black text-xl tracking-tighter text-slate-800 uppercase">KENG<span class="text-sky-500">2026</span></span>
            </div>
            <nav class="flex-1 px-4 space-y-1 overflow-y-auto hide-scroll">
                <button onclick="App.setTab('dashboard')" id="nav-dashboard" class="nav-item sidebar-item-active w-full flex items-center gap-3 px-5 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="text-sm font-bold uppercase tracking-tight">Overview</span>
                </button>
                <button onclick="App.setTab('patients')" id="nav-patients" class="nav-item w-full flex items-center gap-3 px-5 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="users" class="w-5 h-5"></i><span class="text-sm font-bold uppercase tracking-tight">Registry</span>
                </button>
                <button onclick="App.setTab('fitness')" id="nav-fitness" class="nav-item w-full flex items-center gap-3 px-5 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="flask-conical" class="w-5 h-5"></i><span class="text-sm font-bold uppercase tracking-tight">Lab Tools</span>
                </button>
                <button onclick="App.setTab('form')" id="nav-form" class="nav-item w-full flex items-center gap-3 px-5 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="user-plus" class="w-5 h-5"></i><span class="text-sm font-bold uppercase tracking-tight">Add New</span>
                </button>
            </nav>
            <div class="p-6">
                <button onclick="App.logout()" class="w-full flex items-center justify-center gap-2 py-3 text-xs font-black text-rose-400 hover:text-rose-600 border border-rose-50 rounded-xl hover:bg-rose-50 transition-all uppercase">
                    <i data-lucide="log-out" class="w-4 h-4"></i><span>Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-[#f8fafc] overflow-y-auto relative">
            <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-100 flex items-center justify-between px-8 sticky top-0 z-40">
                <div class="flex items-center gap-4">
                    <button onclick="App.toggleSidebar()" class="lg:hidden p-2 text-slate-400"><i data-lucide="menu"></i></button>
                    <h1 id="page-title" class="font-black text-slate-800 text-lg uppercase tracking-widest">Overview</h1>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden md:block text-right">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Connection</p>
                        <p class="text-xs font-bold text-emerald-500">Cloud Active</p>
                    </div>
                    <div class="w-10 h-10 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center"><i data-lucide="wifi" class="w-5 h-5"></i></div>
                </div>
            </header>

            <div class="p-8 max-w-6xl mx-auto w-full">
                <!-- Dashboard Section -->
                <section id="view-dashboard" class="fade-enter space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="classic-card p-8 relative overflow-hidden">
                            <i data-lucide="users" class="absolute right-6 top-6 w-12 h-12 text-sky-50 opacity-20"></i>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Athletes</p>
                            <h2 id="stat-total" class="text-5xl font-black text-slate-800 tracking-tighter">0</h2>
                        </div>
                        <div class="classic-card p-8 relative overflow-hidden">
                            <i data-lucide="activity" class="absolute right-6 top-6 w-12 h-12 text-emerald-50 opacity-20"></i>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Avg BMI Index</p>
                            <h2 id="stat-avg-bmi" class="text-5xl font-black text-emerald-500 tracking-tighter">0</h2>
                        </div>
                        <div class="classic-card p-8 bg-sky-500 text-white relative overflow-hidden">
                            <p class="text-[10px] font-black text-sky-100 uppercase tracking-widest mb-1">System Version</p>
                            <h2 class="text-4xl font-black tracking-tighter">v2.0 PRO</h2>
                            <p class="text-[10px] mt-2 font-bold opacity-80 uppercase tracking-tighter text-sky-200">2026 Standard Protocol</p>
                        </div>
                    </div>
                    <div class="classic-card p-8">
                        <h3 class="font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2 mb-6">
                            <i data-lucide="clock-rewind" class="w-4 h-4 text-sky-500"></i> Recent Activity Log
                        </h3>
                        <div id="recent-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </section>

                <!-- Registry Section -->
                <section id="view-patients" class="hidden fade-enter space-y-6">
                    <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                        <div class="relative w-full md:w-96">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="search-input" onkeyup="App.renderTable()" class="clean-input pl-12" placeholder="Search by name or alias...">
                        </div>
                        <button onclick="App.setTab('form')" class="theme-btn px-8 py-3.5 text-xs font-black uppercase tracking-widest flex items-center gap-2 shadow-lg shadow-sky-100">
                            <i data-lucide="plus" class="w-4 h-4"></i> Create Entry
                        </button>
                    </div>
                    <div class="classic-card overflow-hidden border-none shadow-xl shadow-slate-200/50">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Athlete</th>
                                    <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Basic Profile</th>
                                    <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patient-table-body" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </section>

                <!-- Lab Tools Section -->
                <section id="view-fitness" class="hidden fade-enter space-y-6">
                    <div class="classic-card p-8 border-t-4 border-t-sky-500 bg-gradient-to-br from-white to-sky-50/30">
                        <div class="flex flex-col md:flex-row items-center gap-6">
                            <div class="flex-1">
                                <h3 class="font-black text-slate-800 uppercase tracking-tighter">Lab Data Synchronization</h3>
                                <p class="text-xs text-slate-400 font-bold uppercase mt-1">Select an athlete to auto-fill their current baseline metrics</p>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <select id="fit-registry-select" class="clean-input md:w-72 bg-white"></select>
                                <button onclick="App.loadFromRegistry()" class="theme-btn px-8 py-3 text-xs font-black uppercase tracking-widest">Sync</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Cardiac Lab -->
                        <div class="classic-card p-8 border-t-4 border-t-emerald-500">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h3 class="font-black text-slate-800 uppercase text-sm tracking-widest">Cardiac Lab</h3>
                                    <p class="text-[9px] font-black text-slate-400 uppercase mt-1 tracking-tighter italic">Polar HRR / Karvonen Model</p>
                                </div>
                                <div class="w-10 h-10 bg-emerald-50 text-emerald-500 rounded-xl flex items-center justify-center"><i data-lucide="heart"></i></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="text-[9px] font-black text-slate-400 uppercase">Age</label><input type="number" id="fit-hr-age" class="clean-input"></div>
                                <div><label class="text-[9px] font-black text-slate-400 uppercase">Rest HR</label><input type="number" id="fit-hr-rhr" class="clean-input"></div>
                            </div>
                            <button onclick="App.calculateHR()" class="theme-btn w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-xs font-black uppercase tracking-widest">Map Cardio Zones</button>
                            <div id="res-hr-zones" class="mt-4 space-y-2 hidden"></div>
                        </div>

                        <!-- Metabolic Lab -->
                        <div class="classic-card p-8 border-t-4 border-t-amber-500">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h3 class="font-black text-slate-800 uppercase text-sm tracking-widest">Metabolic Lab</h3>
                                    <p class="text-[9px] font-black text-slate-400 uppercase mt-1 tracking-tighter italic">Mifflin-St Jeor Formula</p>
                                </div>
                                <div class="w-10 h-10 bg-amber-50 text-amber-500 rounded-xl flex items-center justify-center"><i data-lucide="zap"></i></div>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <input type="number" id="fit-weight" class="clean-input" placeholder="W (kg)">
                                <input type="number" id="fit-height" class="clean-input" placeholder="H (cm)">
                                <input type="number" id="fit-age" class="clean-input" placeholder="Age">
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <select id="fit-gender" class="clean-input"><option value="male">Male</option><option value="female">Female</option></select>
                                <select id="fit-activity" class="clean-input">
                                    <option value="1.2">Sedentary (1.2)</option>
                                    <option value="1.55">Moderate (1.55)</option>
                                    <option value="1.9">Elite (1.9)</option>
                                </select>
                            </div>
                            <button onclick="App.calculateMetabolic()" class="theme-btn w-full py-3 bg-amber-500 hover:bg-amber-600 text-xs font-black uppercase tracking-widest">Calculate Energy</button>
                            <div class="grid grid-cols-2 gap-3 mt-4">
                                <div class="p-3 bg-slate-50 rounded-xl text-center"><p class="text-[8px] font-black text-slate-400 uppercase">BMR</p><p id="res-bmr" class="text-xl font-black text-slate-800">0</p></div>
                                <div class="p-3 bg-slate-50 rounded-xl text-center"><p class="text-[8px] font-black text-slate-400 uppercase">TDEE</p><p id="res-tdee" class="text-xl font-black text-slate-800">0</p></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Entry Form Section -->
                <section id="view-form" class="hidden fade-enter">
                    <div class="classic-card p-10 lg:max-w-3xl mx-auto shadow-2xl shadow-slate-200">
                        <form id="patient-form" onsubmit="event.preventDefault(); App.savePatient();" class="space-y-6">
                            <input type="hidden" id="p-edit-id">
                            <div class="flex items-center gap-4 mb-8">
                                <div class="w-12 h-12 bg-sky-50 text-sky-500 rounded-2xl flex items-center justify-center"><i data-lucide="user-plus" class="w-6 h-6"></i></div>
                                <div><h3 class="text-xl font-black text-slate-800">Athlete Registry</h3><p class="text-xs font-bold text-slate-400 uppercase">Enter baseline measurements</p></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2"><label class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest block">Full Name</label><input type="text" id="p-name" required class="clean-input font-bold" placeholder="e.g. Somchai Thai"></div>
                                <div><label class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest block">Alias / Call Sign</label><input type="text" id="p-nickname" class="clean-input" placeholder="Athlete Nickname"></div>
                                <div><label class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest block">Age (Years)</label><input type="number" id="p-age" class="clean-input"></div>
                                <div><label class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest block">Weight (kg)</label><input type="number" id="p-weight" step="0.1" class="clean-input"></div>
                                <div><label class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest block">Height (cm)</label><input type="number" id="p-height" class="clean-input"></div>
                                <div><label class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest block">Resting Heart Rate</label><input type="number" id="p-rhr" class="clean-input"></div>
                                <div class="md:col-span-2"><label class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest block">Coaching Notes</label><textarea id="p-note" rows="4" class="clean-input resize-none" placeholder="Observations, injury history, or specific focus areas..."></textarea></div>
                            </div>
                            <div class="pt-6"><button type="submit" class="theme-btn w-full py-4 font-black uppercase text-xs tracking-[0.2em] shadow-xl shadow-sky-100">Synchronize to Cloud</button></div>
                        </form>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals & Feedback -->
    <div id="profile-modal" class="fixed inset-0 z-[150] hidden items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md">
        <div id="profile-content" class="bg-white p-10 max-w-xl w-full rounded-[40px] shadow-2xl relative fade-enter"></div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-white border border-slate-100 px-6 py-4 rounded-2xl shadow-2xl translate-y-32 opacity-0 transition-all duration-500 flex items-center gap-4 z-[400]">
        <div id="toast-icon"></div>
        <div>
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">System Notification</p>
            <p id="toast-msg" class="text-sm font-black text-slate-800"></p>
        </div>
    </div>

</body>
</html>
